pipeline {
    agent any

    environment {
        DOCKER_CREDS = 'docker-hub-credentials'
        DOCKER_REGISTRY = "carlosp2818"
        APP_USERS = "lms-authnusers"
    }

    stages {
        stage('Build & Push with Plugin') {
            steps {
                script {
                    // Como não é multibranch, definimos a tag manualmente ou usamos 'main'
                    def tag = "main-${env.BUILD_ID}"
                    echo "Building Image with tag: ${tag}"

                    // O contexto do build (../users) é essencial para o Docker encontrar o código
                    def userImage = docker.build("${DOCKER_REGISTRY}/${APP_USERS}:${tag}", "-f ../lms-authnusers/Dockerfile ../lms-authnusers")

                    // Push para o Docker Hub
                    docker.withRegistry('https://index.docker.io/v1/', DOCKER_CREDS) {
                        userImage.push()
                        userImage.push('latest')
                    }
                }
            }
        }

        stage('Deploy with Compose') {
            steps {
                echo "Iniciando Deploy..."
                // Ajustado para o nome da pasta que mencionaste no log anterior
                dir('../lms-authnusers') {
                    sh "docker compose up -d"
                }
            }
        }
    }

    post {
        always {
            echo "Limpando imagens antigas..."
            sh "docker image prune -f"
        }
    }
}