version: "3.9"

services:
    books:
        image: ${DOCKER_IMAGE:-cralos062/lms-books:latest}
        # container_name removido para suportar Blue/Green (via -p no Jenkins)
        ports:
            - "${HOST_PORT:-8087}:8087"
        depends_on:
            mongo_books:
                condition: service_healthy
        environment:
            SPRING_PROFILES_ACTIVE: mongo,bootstrap,base65,instance1
            SPRING_DATA_MONGODB_URI: mongodb://mongoadmin:48aed78edc140a47a9f5d53a@mongo_books:27017/books_1?authSource=admin
            SPRING_RABBITMQ_HOST: rabbitmq
            SPRING_RABBITMQ_PORT: 5672
            FEATURE_MAINTENANCE_KILLSWITCH: ${KILLSWITCH_ACTIVE:-false}
            DARKLAUNCH_SECRET_HEADER: X-LMS-Beta-Access
            FILE_UPLOAD_DIR: uploads
        networks:
            lms_network:
                aliases:
                    - books-service
        volumes:
            - books_uploads:/tmp
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.books-${COLOR:-blue}.rule=PathPrefix(`/api/books`)"
            # Corrigido o nome do service no label para bater com o router
            - "traefik.http.services.books-${COLOR:-blue}.loadbalancer.server.port=8087"
        healthcheck:
            test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8087/actuator/health" ]
            interval: 15s
            timeout: 5s
            retries: 5
            start_period: 60s

    mongo_books:
        image: mongo:6
        restart: unless-stopped
        # Porta 27017 para n√£o colidir com o teu Genre (27019)
        ports:
            - "${MONGO_PORT:-27017}:27017"
        environment:
            MONGO_INITDB_ROOT_USERNAME: mongoadmin
            MONGO_INITDB_ROOT_PASSWORD: 48aed78edc140a47a9f5d53a
            MONGO_INITDB_DATABASE: books_1
        volumes:
            - mongo_books_data:/data/db
        networks:
            lms_network:
                aliases:
                    - mongo_books
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.runCommand({ ping: 1 })"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 20s

networks:
    lms_network:
        external: true

volumes:
    mongo_books_data:
    books_uploads: