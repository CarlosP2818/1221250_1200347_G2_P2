services:
    genre-service:
        image: ${DOCKER_IMAGE:-cralos062/lms-genre:latest}
        container_name: genre-service
        build:
            context: .
        ports:
            - "${HOST_PORT:-8089}:8089"
        depends_on:
            mongo_genres:
                condition: service_healthy
        environment:
            SPRING_PROFILES_ACTIVE: mongo,bootstrap,base65,instance1
            SPRING_DATA_MONGODB_URI: mongodb://mongoadmin:48aed78edc140a47a9f5d53a@mongo_genres:27017/genres_1?authSource=admin
            SPRING_RABBITMQ_HOST: rabbitmq
            SPRING_RABBITMQ_PORT: 5672
            FILE_UPLOAD_DIR: uploads
            FEATURE_MAINTENANCE_KILLSWITCH: ${KILLSWITCH_ACTIVE:-false}
            DARKLAUNCH_SECRET_HEADER: X-LMS-Beta-Access
        networks:
            lms_network:
                aliases:
                    - genre-service
        volumes:
            - uploaded_files_volume_1:/tmp
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.genre-${COLOR:-blue}-router.rule=PathPrefix(`/api/genres`)"
            - "traefik.http.routers.genre-${COLOR:-blue}-router.entrypoints=web"
            - "traefik.http.routers.genre-${COLOR:-blue}-router.service=genre-canary-service"

            # LÃ³gica de Pesos para Canary
            - "traefik.http.services.genre-canary-service.loadbalancer.weighted.services.genre-${COLOR:-blue}-backend@docker"
            - "traefik.http.services.genre-canary-service.loadbalancer.services.genre-${COLOR:-blue}-backend@docker.weight=${WEIGHT:-0}"
            - "traefik.http.services.genre-${COLOR:-blue}-backend@docker.loadbalancer.server.port=8089"

        healthcheck:
            test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8089/actuator/health" ]
            interval: 15s
            timeout: 5s
            retries: 5
            start_period: 60s

    mongo_genres:
        image: mongo:6
        restart: unless-stopped
        environment:
            MONGO_INITDB_ROOT_USERNAME: mongoadmin
            MONGO_INITDB_ROOT_PASSWORD: 48aed78edc140a47a9f5d53a
            MONGO_INITDB_DATABASE: genres_1
        volumes:
            - mongo_data:/data/db
        networks:
            lms_network:
                aliases:
                    - mongo_genres
        healthcheck:
            # MongoDB 6 usa mongosh
            test: ["CMD", "mongosh", "--eval", "db.runCommand({ ping: 1 })"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 20s

networks:
    lms_network:
        external: true

volumes:
    mongo_data:
    uploaded_files_volume_1: