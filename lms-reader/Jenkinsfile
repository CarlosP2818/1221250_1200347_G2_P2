pipeline {
    agent any

    parameters {
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch a construir')
    }

    environment {
        DOCKER_REGISTRY_CREDENTIALS = 'docker-hub-credentials'
        DOCKER_IMAGE_NAME = 'lms-readers' // Nome do serviço Readers
        DOCKER_NAMESPACE = 'cralos062'
        IMAGE_FULL_NAME = "${DOCKER_NAMESPACE}/${DOCKER_IMAGE_NAME}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Unit Tests') {
            steps {
                dir('lms-readers') {
                    sh 'mvn clean test'
                }
            }
        }

        stage('Static Analysis & Mutation') {
            parallel {
                stage('SpotBugs') {
                    steps {
                        dir('lms-readers') {
                            sh 'mvn com.github.spotbugs:spotbugs-maven-plugin:4.8.6.2:spotbugs'
                        }
                    }
                }
                stage('Pitest') {
                    steps {
                        dir('lms-readers') {
                            sh 'mvn org.pitest:pitest-maven:mutationCoverage'
                        }
                    }
                }
            }
        }

        stage('Package Artifact') {
            steps {
                dir('lms-readers') {
                    sh 'mvn package -DskipTests'
                    archiveArtifacts artifacts: 'target/*.jar'
                }
            }
        }

       stage('Build & Push Docker Image') {
           steps {
               dir('lms-readers') {
                   script {
                       def shortCommit = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
                       env.BUILD_TAG = "${env.BUILD_NUMBER}-${shortCommit}"

                       echo "A gerar imagem do Readers com a tag: ${env.BUILD_TAG}"

                       def customImage = docker.build("${IMAGE_FULL_NAME}:${env.BUILD_TAG}")
                       docker.withRegistry('https://index.docker.io/v1/', DOCKER_REGISTRY_CREDENTIALS) {
                           customImage.push("${env.BUILD_TAG}")
                       }
                   }
               }
           }
       }

        stage('Deploy & Health Check') {
            steps {
                dir('lms-readers') {
                    script {
                        docker.withRegistry('https://index.docker.io/v1/', DOCKER_REGISTRY_CREDENTIALS) {
                            // Injetamos a tag ÚNICA no docker-compose do Readers
                            withEnv(["DOCKER_IMAGE=${IMAGE_FULL_NAME}:${env.BUILD_TAG}"]) {
                                sh "docker network create lms_network || true"

                                echo "--- Requisito: Zero Downtime Rollout (Readers) ---"
                                sh "docker compose pull readers"
                                sh "docker compose up -d --remove-orphans"

                                echo "--- Requisito: Health checks in prod ---"
                                timeout(time: 5, unit: 'MINUTES') {
                                    waitUntil {
                                        // Busca o ID do contentor do serviço 'readers'
                                        def containerId = sh(script: "docker compose ps -q readers | head -n 1", returnStdout: true).trim()
                                        if (!containerId) return false

                                        def health = sh(script: "docker inspect --format='{{.State.Health.Status}}' ${containerId}", returnStdout: true).trim()
                                        echo "Estado do contentor Readers: ${health}"

                                        if (health == "unhealthy") {
                                            sh "docker logs ${containerId}"
                                            error "Deploy falhou: Contentor Readers unhealthy"
                                        }
                                        return (health == "healthy")
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Smoke Tests') {
            steps {
                dir('lms-readers') {
                    script {
                        echo "--- Executando Smoke Tests com k6 via Docker ---"
                        // Ajustado para a porta 8090 (ou 80 se fores via Traefik)
                        sh """
                            docker run --rm --network host -i loadimpact/k6 run - < smoke_test.js \
                            -e READERS_URL="http://localhost:8090/api/readers"
                        """
                    }
                }
            }
        }

        stage('Promote to Latest') {
            steps {
                script {
                    echo "--- Todos os testes passaram! Promovendo imagem Readers para Latest ---"
                    docker.withRegistry('https://index.docker.io/v1/', DOCKER_REGISTRY_CREDENTIALS) {
                        sh "docker pull ${IMAGE_FULL_NAME}:${env.BUILD_TAG}"
                        sh "docker tag ${IMAGE_FULL_NAME}:${env.BUILD_TAG} ${IMAGE_FULL_NAME}:latest"
                        sh "docker push ${IMAGE_FULL_NAME}:latest"
                    }
                }
            }
        }
    }

    post {
        failure {
            script {
                echo "--- Requisito: Automatically revoke release (Rollback Readers) ---"
                dir('lms-readers') {
                    withEnv(["DOCKER_IMAGE=${IMAGE_FULL_NAME}:latest"]) {
                        sh "docker compose down"
                        sh "docker compose up -d"
                    }
                }
            }
        }
        always {
            echo "--- Cleaning workspace ---"
        }
    }
}