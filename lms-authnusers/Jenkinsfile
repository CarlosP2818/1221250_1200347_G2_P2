pipeline {
    agent any

    parameters {
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch a construir')
    }

    environment {
        DOCKER_REGISTRY_CREDENTIALS = 'docker-hub-credentials'
        DOCKER_IMAGE_NAME = 'lms-authnusers'
        DOCKER_NAMESPACE = 'cralos062'
        IMAGE_FULL_NAME = "${DOCKER_NAMESPACE}/${DOCKER_IMAGE_NAME}"
    }

    stages {
        stage('Checkout') { steps { checkout scm } }

        stage('Build & Unit Tests') {
            steps { dir('lms-authnusers') { sh 'mvn clean test' } }
        }

        stage('Static Analysis & Mutation') {
            parallel {
                stage('SpotBugs') { steps { dir('lms-authnusers') { sh 'mvn com.github.spotbugs:spotbugs-maven-plugin:4.8.6.2:spotbugs' } } }
                stage('Pitest') { steps { dir('lms-authnusers') { sh 'mvn org.pitest:pitest-maven:mutationCoverage' } } }
            }
        }

        stage('Package Artifact') {
            steps { dir('lms-authnusers') { sh 'mvn package -DskipTests'; archiveArtifacts artifacts: 'target/*.jar' } }
        }

        stage('Build & Push Docker Image') {
            steps {
                dir('lms-authnusers') {
                    script {
                        def shortCommit = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
                        def buildTag = "${env.BUILD_NUMBER}-${shortCommit}"
                        def customImage = docker.build("${IMAGE_FULL_NAME}:${buildTag}")
                        docker.withRegistry('https://index.docker.io/v1/', DOCKER_REGISTRY_CREDENTIALS) {
                            customImage.push("${buildTag}")
                            customImage.push("latest")
                        }
                    }
                }
            }
        }

        stage('Deploy & Health Check') {
                    steps {
                        dir('lms-authnusers') {
                            script {
                                docker.withRegistry('https://index.docker.io/v1/', DOCKER_REGISTRY_CREDENTIALS) {
                                    // Garantimos que a tag 'latest' é passada para o docker-compose.yml
                                    withEnv(["DOCKER_IMAGE=${IMAGE_FULL_NAME}:latest"]) {
                                        sh "docker network create lms_network || true"

                                        echo "--- Requisito: Zero Downtime Rollout ---"
                                        sh "docker compose pull users"
                                        sh "docker compose up -d --remove-orphans"

                                        echo "--- Requisito: Health checks in prod ---"
                                        timeout(time: 5, unit: 'MINUTES') {
                                            waitUntil {
                                                // Obtém o ID dinâmico (resolve o problema do nome fixo)
                                                def containerId = sh(script: "docker compose ps -q users | head -n 1", returnStdout: true).trim()

                                                if (!containerId) return false

                                                def health = sh(script: "docker inspect --format='{{.State.Health.Status}}' ${containerId}", returnStdout: true).trim()
                                                echo "Estado do contentor: ${health}"

                                                if (health == "unhealthy") {
                                                    sh "docker logs ${containerId}"
                                                    error "Deploy falhou: Contentor unhealthy"
                                                }
                                                return (health == "healthy")
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                stage('Smoke Tests') {
                    steps {
                        dir('lms-authnusers') {
                            // Aqui a porta 30081 deve bater com o docker-compose
                            sh 'export AUTH_URL="http://localhost:30081/api/public/login" && k6 run smoke_test.js'
                        }
                    }
                }
            }

            post {
                    failure {
                        script {
                            echo "--- Requisito: Automatically revoke release (Rollback) ---"
                            // IMPORTANTE: O rollback tem de acontecer ANTES do cleanWs
                            dir('lms-authnusers') {
                                withEnv(["DOCKER_IMAGE=${IMAGE_FULL_NAME}:latest"]) {
                                    // Forçamos o uso do ficheiro local
                                    sh "docker compose -f docker-compose.yml down"
                                    sh "docker compose -f docker-compose.yml up -d"
                                }
                            }
                        }
                    }
                }
}