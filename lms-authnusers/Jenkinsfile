pipeline {
    agent any

    tools {
        maven 'M3'
    }

    parameters {
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch a construir')
    }

    environment {
        DOCKER_REGISTRY_CREDENTIALS = 'docker-hub-credentials'
        DOCKER_IMAGE_NAME = 'lms-authnusers'
        DOCKER_NAMESPACE = 'cralos062'
        IMAGE_FULL_NAME = "${DOCKER_NAMESPACE}/${DOCKER_IMAGE_NAME}"
        SSH_CREDENTIALS_ID = 'isep-vm-root'
        VM_ADDRESS = 'vs578.dei.isep.ipp.pt'
    }

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Build & Unit Tests') {
            steps {
                dir('lms-authnusers') { sh 'mvn clean test' }
            }
        }

        stage('Static Analysis & Mutation') {
            parallel {
                stage('SpotBugs') {
                    steps { dir('lms-authnusers') { sh 'mvn com.github.spotbugs:spotbugs-maven-plugin:4.8.6.2:spotbugs' } }
                }
                stage('Pitest') {
                    steps { dir('lms-authnusers') { sh 'mvn org.pitest:pitest-maven:mutationCoverage' } }
                }
            }
        }

        stage('Package Artifact') {
            steps {
                dir('lms-authnusers') {
                    sh 'mvn package -DskipTests'
                    archiveArtifacts artifacts: 'target/*.jar'
                }
            }
        }

        stage('Build & Push Docker Image') {
            steps {
                dir('lms-authnusers') {
                    script {
                        def shortCommit = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
                        env.BUILD_TAG = "${env.BUILD_NUMBER}-${shortCommit}"

                        docker.withRegistry('https://index.docker.io/v1/', DOCKER_REGISTRY_CREDENTIALS) {
                            def customImage = docker.build("${IMAGE_FULL_NAME}:${env.BUILD_TAG}")
                            customImage.push("${env.BUILD_TAG}")
                            customImage.push("latest")
                        }
                    }
                }
            }
        }

        stage('Blue-Green Deploy') {
            steps {
                dir('lms-authnusers') {
                    script {

                        def isGreenActive = sh(script: "docker ps --format '{{.Names}}' | grep users-green || true", returnStdout: true).trim()
                        env.ACTIVE_COLOR = isGreenActive ? "green" : "blue"
                        env.NEXT_COLOR = isGreenActive ? "blue" : "green"
                        env.NEXT_PORT = (env.NEXT_COLOR == "blue") ? "30080" : "30081"

                        echo "Ativo: ${env.ACTIVE_COLOR} | Deploying: ${env.NEXT_COLOR} na porta ${env.NEXT_PORT}"

                        withEnv([
                            "DOCKER_IMAGE=${IMAGE_FULL_NAME}:${env.BUILD_TAG}",
                            "COLOR=${env.NEXT_COLOR}",
                            "HOST_PORT=${env.NEXT_PORT}"
                        ]) {
                            sh "docker network create lms_network || true"

                            // Sobe a nova cor com um nome de projeto isolado
                            sh "docker compose -p users-${env.NEXT_COLOR} up -d users"

                            echo "--- Health Check da nova versão (${env.NEXT_COLOR}) ---"
                            timeout(time: 5, unit: 'MINUTES') {
                                waitUntil {
                                    def containerId = sh(script: "docker compose -p users-${env.NEXT_COLOR} ps -q users", returnStdout: true).trim()
                                    if (!containerId) return false
                                    def health = sh(script: "docker inspect --format='{{.State.Health.Status}}' ${containerId}", returnStdout: true).trim()
                                    return (health == "healthy")
                                }
                            }
                        }
                    }
                }
            }
        }

       stage('Remote Blue-Green Deploy') {
           steps {
               sshagent([env.SSH_CREDENTIALS_ID]) {
                   script {
                       dir('lms-authnusers') {
                           // Configuração de flags para ignorar verificação de host
                           def sshFlags = "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

                           // PASSAGEM CRÍTICA: Definir o DOCKER_HOST para usar o binário SSH do sistema
                           // Em algumas versões, o Docker exige que as flags venham via DOCKER_SSH_COMMAND
                           // mas noutras funciona melhor chamando o comando SSH explicitamente.

                           withEnv([
                               "DOCKER_HOST=ssh://root@${env.VM_ADDRESS}",
                               "DOCKER_IMAGE=${IMAGE_FULL_NAME}:${env.BUILD_TAG}",
                               "COLOR=${env.NEXT_COLOR}",
                               "HOST_PORT=${env.NEXT_PORT}",
                               "DOCKER_SSH_COMMAND=ssh ${sshFlags}"
                           ]) {
                               echo "--- Verificando conexão via SSH ---"
                               // Teste de força bruta: se este comando passar, o SSH está a funcionar
                               sh "ssh ${sshFlags} root@${env.VM_ADDRESS} docker info"

                               echo "--- Fazendo Deploy na VM ISEP (${env.NEXT_COLOR}) ---"
                               // Criar rede remotamente via SSH direto para garantir execução
                               sh "ssh ${sshFlags} root@${env.VM_ADDRESS} 'docker network create lms_network || true'"

                               // Executar o Compose
                               sh "docker compose -p users-${env.NEXT_COLOR} up -d users"

                               echo "--- Aguardando Health Check ---"
                               timeout(time: 5, unit: 'MINUTES') {
                                   waitUntil {
                                       try {
                                           // Consultar o status remotamente
                                           def containerId = sh(script: "docker compose -p users-${env.NEXT_COLOR} ps -q users", returnStdout: true).trim()
                                           if (!containerId) return false

                                           def health = sh(script: "docker inspect --format='{{.State.Health.Status}}' ${containerId}", returnStdout: true).trim()
                                           return (health == "healthy")
                                       } catch (Exception e) {
                                           return false
                                       }
                                   }
                               }
                               echo "--- Deploy com sucesso na cor ${env.NEXT_COLOR}! ---"
                           }
                       }
                   }
               }
           }
       }

      stage('Verify Strategies (k6)') {
                steps {
                dir('lms-authnusers') {
                    script {
                        // 1. Descobrimos o nome do container atual (ex: users-green-users-1)
                        def containerName = sh(script: "docker ps --filter 'name=users-${env.NEXT_COLOR}' --format '{{.Names}}' | head -n 1", returnStdout: true).trim()

                        echo "--- Validando Estratégias no container: ${containerName} ---"

                        // 2. Ativamos o Kill Switch antes de rodar o k6
                        withEnv([
                            "KILLSWITCH_ACTIVE=true",
                            "COLOR=${env.NEXT_COLOR}",
                            "HOST_PORT=${env.NEXT_PORT}",
                            "DOCKER_IMAGE=${IMAGE_FULL_NAME}:${env.BUILD_TAG}"
                        ]) {
                            sh "docker compose -p users-${env.NEXT_COLOR} up -d --no-deps users"
                            echo "Aguardando 10s para propagação da configuração..."
                            sleep 10

                            // 3. Chamamos o k6 passando o TARGET_URL via variável de ambiente (-e)
                            // Usamos a porta 8080 pois o k6 entra na rede 'lms_network'
                            sh """
                                docker run --rm --network lms_network -i loadimpact/k6 run - < verify_strategies.js \
                                -e TARGET_URL="http://${containerName}:8080"
                            """
                        }

                        // 4. Restaurar para Kill Switch OFF para os estágios seguintes (Smoke Tests)
                        echo "--- Restaurando Serviço (Kill Switch OFF) ---"
                        withEnv([
                            "KILLSWITCH_ACTIVE=false",
                            "COLOR=${env.NEXT_COLOR}",
                            "HOST_PORT=${env.NEXT_PORT}",
                            "DOCKER_IMAGE=${IMAGE_FULL_NAME}:${env.BUILD_TAG}"
                        ]) {
                            sh "docker compose -p users-${env.NEXT_COLOR} up -d --no-deps users"
                        }
                    }
                    }
                }
            }

               stage('Manual Approval') {
                   steps {
                       input message: "Versão ${env.NEXT_COLOR} validada. Deseja promover e desligar ${env.ACTIVE_COLOR}?", ok: "Promover"
                   }
               }

        stage('Smoke Tests') {
            steps {
                dir('lms-authnusers') {
                    script {
                        echo "--- Smoke Tests na porta ${env.NEXT_PORT} ---"
                        sh """
                            docker run --rm --network host -i loadimpact/k6 run - < smoke_test.js \
                            -e AUTH_URL="http://localhost:${env.NEXT_PORT}/api/public/login"
                        """
                    }
                }
            }
        }

        stage('Switch Traffic & Cleanup') {
            steps {
                script {
                    echo "--- Sucesso! Removendo versão antiga: ${env.ACTIVE_COLOR} ---"
                    dir('lms-authnusers') {
                        sh "docker compose -p users-${env.ACTIVE_COLOR} down || true"
                    }
                }
            }
        }
    }

    post {
        failure {
            script {
                echo "--- Falha no Deploy. Limpando tentativa de ${env.NEXT_COLOR} ---"
                dir('lms-authnusers') {
                    sh "docker compose -p users-${env.NEXT_COLOR} down || true"
                }
            }
        }
        always { cleanWs() }
    }
}