version: "3.9"

services:
  authors:
    image: ${DOCKER_IMAGE:-cralos062/lms-authors:latest}
    # container_name removido para permitir Blue/Green simultâneo
    ports:
      - "${HOST_PORT:-8088}:8088"
    depends_on:
      mongo_authors:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: mongo,bootstrap,base65,instance1
      SPRING_DATA_MONGODB_URI: mongodb://mongoadmin:48aed78edc140a47a9f5d53a@mongo_authors:27017/authors_1?authSource=admin
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      FEATURE_MAINTENANCE_KILLSWITCH: ${KILLSWITCH_ACTIVE:-false}
      DARKLAUNCH_SECRET_HEADER: X-LMS-Beta-Access
      FILE_UPLOAD_DIR: uploads
    networks:
      lms_network:
        aliases:
          - authors-service
    volumes:
      - authors_uploads:/tmp
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authors-${COLOR:-blue}.rule=PathPrefix(`/api/authors`)"
      - "traefik.http.services.authors-${COLOR:-blue}.loadbalancer.server.port=8088"
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8088/actuator/health" ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 60s

  mongo_authors:
    image: mongo:6
    restart: unless-stopped
    ports:
      - "${MONGO_PORT:-27018}:27017" # Porta dinâmica para evitar conflitos
    environment:
      MONGO_INITDB_ROOT_USERNAME: mongoadmin
      MONGO_INITDB_ROOT_PASSWORD: 48aed78edc140a47a9f5d53a
      MONGO_INITDB_DATABASE: authors_1
    volumes:
      - mongo_authors_data:/data/db
    networks:
      lms_network:
        aliases:
          - mongo_authors
    healthcheck:
      # MongoDB 6 utiliza mongosh
      test: ["CMD", "mongosh", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

networks:
  lms_network:
    external: true

volumes:
  mongo_authors_data:
  authors_uploads: